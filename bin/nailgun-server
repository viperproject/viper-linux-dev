#!/bin/bash

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
source "$DIR/settings.sh"

NAILGUN_JAR=/usr/share/java/nailgun-0.9.0.jar
NAILGUN_MAIN=com.martiansoftware.nailgun.NGServer
SILICON_JAR=/home/developer/source/chalice2silver/target/scala-2.11/chalice2sil.jar
JAVA_CLASSPATH="${NAILGUN_JAR}:${SILICON_JAR}"

EXISTS=$(${DOCKER_BIN} ps -a | grep viper-nailgun-server)
if [[ -n "$EXISTS" ]]; then
  RUNNING=$(${DOCKER_BIN} inspect --format='{{.State.Running}}' "${DOCKER_NAILGUN_SERVER_NAME}")
else
  RUNNING="none"
fi

if [[ "${RUNNING}" == "false" ]]; then
  ${DOCKER_BIN} rm "${DOCKER_NAILGUN_SERVER_NAME}"
fi

if [[ "${RUNNING}" != "true" ]]; then

  echo "Docker container is not running. Startingâ€¦"
  echo "You might need to rerun the program."

  ${DOCKER_COMMAND_DETTACHED} \
    --name "${DOCKER_NAILGUN_SERVER_NAME}" \
    -p 2113:2113 \
    -e "BOOGIE_EXE=/usr/bin/boogie" \
    -e "Z3_EXE=/usr/bin/z3" \
    "${DOCKER_IMAGE}" \
    /usr/bin/fish \
    -c "java -cp ${JAVA_CLASSPATH} ${NAILGUN_MAIN}"

  exit 1

fi
